name: Deploy Laravel Admin to Hpanel

on:
  push:
    branches: [develop]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        # pin versi action biar stabil
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e

            PROJECT_DIR=/home/u723134020/domains/ahmakbar.com/api-test-app-d
            PUBLIC_LINK=/home/u723134020/domains/ahmakbar.com/public_html/api-test-app

            # Pakai Node/npm & Composer yang sudah ada di server
            export PATH="$HOME/bin/nodejs/bin:$PATH"
            node -v
            npm -v

            # Clone pertama kali
            if [ ! -d "$PROJECT_DIR/.git" ]; then
              mkdir -p "$PROJECT_DIR"
              git clone https://github.com/ahmakbardev/api-test-app-d.git "$PROJECT_DIR"
            fi

            cd "$PROJECT_DIR"
            git fetch origin develop
            git reset --hard origin/develop

            # Build assets (jalan kalau ada package.json)
            if [ -f package.json ]; then
              npm ci --legacy-peer-deps || npm install --legacy-peer-deps
              npm run prod || npm run build || true
            fi

            # Composer (pakai path langsung, bukan alias)
            $HOME/bin/composer install --no-dev --optimize-autoloader

            # Laravel
            php artisan key:generate --force || true
            php artisan migrate --force || true
            php artisan storage:link || true
            php artisan route:clear
            php artisan config:cache
            php artisan optimize

            # Symlink public ke subdomain (idempotent)
            ln -sfn "$PROJECT_DIR/public" "$PUBLIC_LINK"
